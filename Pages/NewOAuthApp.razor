@page "/OAuthApps/new"
@using SerbleWebsite.Data.Schemas
@using SerbleWebsite.Data
@inject IJSRuntime JsRuntime
@inject NavigationManager NavigationManager

<RequireLogin Callback="OnLoad"></RequireLogin>
<LoginStyles></LoginStyles>

<div class="text-center form-signin">
    <div>
        <h1 class="h3 mb-3 fw-normal">New OAuth Application</h1>
        
        <p style="color: red;">
            @switch (_error) {
                
                case Error.None:
                    break;
                    
                case Error.NullFields:
                    <p>You must fill out all fields</p>
                    break;
                    
               case Error.Wait:
                    <p>Please try again in 5 seconds...</p>
                    break;

                default:
                    throw new ArgumentOutOfRangeException();
            }
        </p>
    
        <div class="form-floating">
            <input
                type="text" 
                class="form-control" 
                id="name" 
                placeholder="App Name" 
                maxlength="255"
                style="background-color: rgb(34, 34, 34); color: #ffffff">
          <label for="floatingInput">Application Name</label>
        </div>
        <div class="form-floating" style="padding-top: 10px; padding-bottom: 10px">
            <textarea
                class="form-control" 
                id="desc" 
                placeholder="App Description" 
                maxlength="1024"
                style="background-color: rgb(34, 34, 34); color: #ffffff"></textarea>
            <label for="desc">Description</label>
        </div>
        
        <br/>

        <button class="w-100 btn btn-lg btn-primary" @onclick="Submit" style="padding-top: 10px">Create</button>
    </div>
</div>


@code {

    private Error _error = Error.None;
    private string? _userId;

    private bool OnLoad(User user) {
        _userId = user.Id;
        return true;
    }

    private void ReloadText() {
        InvokeAsync(StateHasChanged).Wait();
    }

    private async void Submit() {
        if (_userId == null) {
            _error = Error.Wait;
            return;
        }
        HtmlInteractor interactor = new(JsRuntime);
        string name = await interactor.GetValue("name");
        string desc = await interactor.GetValue("desc");
        OAuthApp app = new (_userId) {
            Name = name,
            Description = desc
        };
        Program.StorageService!.AddOAuthApp(app);
        _error = Error.None;
        NavigationManager.NavigateTo("/OAuthApps");
    }
    
    enum Error {
        None,
        NullFields,
        Wait
    }
    
}